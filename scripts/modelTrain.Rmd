## Model the `train` data

Select a subset of non-near-zero variance variables.

```{r}
train <-
  select(train, -matches(paste(nearzero$rowname, collapse = "|"))) %>%
  select(-matches("id"))
```

Set the control parameters.

```{r}
ctrl <- trainControl(method = "cv",
                     number = 10,
                     savePredictions = TRUE,
                     allowParallel = FALSE)
```


### Regression tree

Fit model over the tuning parameters.

```{r}
trainingModel <- train(loss ~ .,
                       method = "rpart",
                       data = train,
                       trControl = ctrl)
```

Evaluate the model on the training dataset

```{r}
trainingModel
hat <-
  train %>%
  transform(hat = predict(trainingModel, .)) %>%
  select(matches("loss|hat"))
cor(hat[, c("loss", "hat")])
ggplot(hat, aes(x = loss, y = hat)) +
  scale_x_log10() +
  scale_y_log10() +
  stat_density_2d(aes(fill = ..level..), geom = "polygon") +
  scale_fill_gradient("density", low = "blue", high = "white") +
  geom_abline(intercept = 0, slope = 1) +
  labs(title = sprintf("Correlation = %.03g", cor(hat[, c("loss", "hat")])[1, 2])) +
  theme_bw()
```

Display the final model


```{r}
varImp(trainingModel)
trainingModel$finalModel
```
